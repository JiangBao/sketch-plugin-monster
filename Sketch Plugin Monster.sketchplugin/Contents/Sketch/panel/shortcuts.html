<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sketch Plugin Monster</title>
  <style>
    body {
      margin: 0;
      font-family: "Arial", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", "sans-serif";
    }
    header {
      text-align: center;
    }
    .clearfix::before, .clearfix::after {
      content: '';
      display: table;
    }
    .clearfix::before {
      clear: both;
    }
    .page-title {
      margin: 10px 0;
      font-weight: normal;
      font-size: 24px;
      line-height: 40px;
      color: #333;
    }
    .usage-desc {
      margin: 0 0 15px;
      font-size: 14px;
      color: #999;
    }
    .conflict-warning {
      display: inline-block;
      margin: 0 20px 0;
      padding: 6px 20px;
      color: #EF4444;
      font-size: 14px;
      line-height: 20px;
      background-color: #fff;
      border: 1px solid #EF4444;
      box-sizing: border-box;
      border-radius: 64px;
    }
    .conflict-warning:empty {
      display: none;
    }
    .conflict-details {
      list-style: none;
      display: block;
      margin: 0 auto 20px;
      padding: 0;
      width: 200px;
    }
    .conflict-details:empty {
      display: none;
    }
    .conflict-details li {
      padding: 8px 15px;
      color: #333;
      font-size: 14px;
      line-height: 14px;
      letter-spacing: 2px;
      text-align: left;
      border: 1px solid #ccc;
      border-top: 0;
      cursor: pointer;
    }
    .conflict-details li:hover {
      color: #EF4444;
    }
    .conflict-details li:last-child {
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
    }
    .conflict-details li span {
      float: right;
      font-size: 14px;
      font-style: italic;
      color: #888;
    }
    #panel-wrapper .btn-filter-reset {
      margin: -5px 0 5px;
      float: right;
      padding: 0 24px;
      color: #4990E2;
      font-size: 16px;
      line-height: 30px;
      text-decoration: none;
    }
    #panel-wrapper .btn-filter-reset:hover {
      color: #3F7FC8;
    }
    #panel-wrapper .btn-filter-reset,
    #panel-wrapper.filtered .plugin-shortcuts-panel,
    #panel-wrapper.filtered .plugin-shortcuts-panel tr {
      display: none;
    }
    #panel-wrapper.filtered .btn-filter-reset {
      display: inline;
    }
    #panel-wrapper.filtered .plugin-shortcuts-panel.filter-target {
      display: block;
    }
    #panel-wrapper.filtered .plugin-shortcuts-panel tr.filter-target {
      display: table-row;
    }
    .plugin-shortcuts-panel {
      margin-bottom: -1px;
      border-top: 1px solid #ccc;
      overflow: hidden;
      transition: max-height .5s cubic-bezier(0.215, 0.61, 0.355, 1);
    }
    .plugin-shortcuts-panel.collapse {
      max-height: 61px!important;
    }
    .plugin-shortcuts-panel.collapse h2::before {
      transform: rotate(180deg);
    }
    .plugin-shortcuts-panel.shortcut-conflict h2 {
      color: #EF4444;
    }
    .plugin-shortcuts-panel.shortcut-conflict h2::after {
      content: '';
      margin-left: 5px;
      display: inline-block;
      width: 16px;
      height: 16px;
      background: url('assets/img/icon_warning.png') no-repeat center center;
      background-size: 100%;
    }
    .plugin-shortcuts-panel h2 {
      position: relative;
      margin: 0;
      padding: 0 24px;
      font-weight: normal;
      font-size: 24px;
      line-height: 60px;
      color: #4990E2;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
      -webkit-user-select: none;
    }
    .plugin-shortcuts-panel h2::before {
      content: '';
      position: absolute;
      top: 50%;
      right: 20px;
      margin-top: -6px;
      display: block;
      width: 12px;
      height: 12px;
      background: url('assets/img/icon_arrow.png') no-repeat center center;
      background-size: 100%;
      transition: transform .5s cubic-bezier(0.215, 0.61, 0.355, 1);
    }
    .plugin-shortcuts-panel table {
      width: 100%;
      border-collapse: collapse;
    }
    .plugin-shortcuts-panel table tr {
      background-color: #fbfbfb;
    }
    .plugin-shortcuts-panel table tr.shortcut-conflict {
      background-image: linear-gradient(to right, rgba(239,68,68,.12), rgba(239,68,68,0));
      background-attachment: fixed;
    }
    .plugin-shortcuts-panel table tr.shortcut-conflict td:first-child {
      box-shadow: 4px 0 0 #EF4444 inset;
    }
    .plugin-shortcuts-panel table td {
      height: 48px;
      line-height: 48px;
      color: #666;
      border-bottom: 1px solid #ddd;
    }
    .plugin-shortcuts-panel table td:first-child {
      padding-left: 40px;
    }
    .plugin-shortcuts-panel table td:last-child {
      width: 150px;
    }
    .plugin-shortcuts-panel table input {
      width: 92px;
      height: 28px;
      padding: 0 10px;
      font-size: 14px;
      color: #666;
      text-indent: -1px;
      letter-spacing: 1px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 14px;
      box-sizing: border-box;
      vertical-align: middle;
      cursor: pointer;
      box-shadow: 0 0 0 10px rgba(0,153,255,0);
      outline: none;
    }
    .plugin-shortcuts-panel table input:focus {
      cursor: initial;
      transition: border-color .2s, box-shadow .4s;
      border-color: #4990E2;
      box-shadow: 0 0 0 3px rgba(0,153,255,.3);
    }
    .plugin-shortcuts-panel table input:invalid + .btn-clear {
      display: none;
    }
    .plugin-shortcuts-panel table .btn-clear {
      margin: 0 10px;
      width: 24px;
      height: 24px;
      background: url('assets/img/icon_clear.png') no-repeat;
      background-size: 18px;
      background-position: center center;
      border: 0;
      vertical-align: middle;
      cursor: pointer;
    }
    .plugin-shortcuts-panel table .btn-clear:hover {
      opacity: .8;
    }
    .plugin-shortcuts-panel table .btn-clear:active {
      opacity: .6;
    }
  </style>
</head>
<body>
  <header>
    <h1 class="page-title"></h1>
    <p class="usage-desc"></p>
    <span class="conflict-warning"></span>
    <ul class="conflict-details"></ul>
  </header>
  <script type="text/template" id="shortcuts-template">
    <a href="javascript: filterPluginList();" class="btn-filter-reset">Clear filter</a>
    <div class="clearfix"></div>
    <%for (var i = 0; i < plugins.length; i++) {%>
    <div class="plugin-shortcuts-panel collapse">
      <h2><%=plugins[i].name %></h2>
      <table>
        <tbody>
          <%for (var j = 0; j < plugins[i].commands.length; j++) {%>
          <tr>
            <td><%=plugins[i].commands[j].name %></td>
            <td>
              <input type="text"
                     required="required"
                     tabindex="-2"
                     placeholder="<%=i18n.none %>"
                     value="<%=convertShortcut(plugins[i].commands[j].shortcut) %>"
                     data-plugin="<%=plugins[i].name %>"
                     data-command="<%=plugins[i].commands[j].name %>"
                     data-identifier="<%=plugins[i].commands[j].identifier %>">
              <button class="btn-clear"
                      data-plugin="<%=plugins[i].name %>"
                      data-identifier="<%=plugins[i].commands[j].identifier %>"></button>
            </td>
          </tr>
          <%}%>
        </tbody>
      </table>
    </div>
    <%}%>
  </script>
  <script src="assets/js/Notification.js?v0.1.1"></script>
  <script src="assets/js/TemplateEngine.js?v0.1.1"></script>
  <script src="assets/js/ShortcutsHandler.js?v0.1.1"></script>
  <script src="assets/js/common.js?v0.1.1"></script>
  <script>
    var globalNotice = new Notification();
    var shortcutsHandler;
    var i18n;

    /**
     * render plugin list into page
     * @param  {Object} source source data
     */
    function renderList(source) {
      var listRender = new TemplateEngine('shortcuts-template');
      var wrapper = document.createElement('div');
      var commands = {};
      var inputs;

      wrapper.id = 'panel-wrapper';
      wrapper.innerHTML = listRender({ plugins: shortcutsHandler.getCommandList(), i18n: i18n });

      // check and display conflicting shortcut key
      inputs = wrapper.getElementsByTagName('input');

      Array.prototype.forEach.call(inputs, function (input) {
        if (input.value) {
          commands[input.value] = typeof(commands[input.value]) === 'number' ?
                                  (commands[input.value] + 1) :
                                  0;
        }
      });

      Array.prototype.forEach.call(inputs, function (input) {
        var commandWrapper = input.parentNode.parentNode;
        var pluginWrapper = commandWrapper.parentNode.parentNode.parentNode;

        if (commands[input.value]) {
           commandWrapper.classList.add('shortcut-conflict');
           pluginWrapper.classList.add('shortcut-conflict');
           pluginWrapper.classList.remove('collapse');
        }
      });

      // wait for DOM updated
      setTimeout(function () {
        renderConflictMsg();

        // support collapse
        Array.prototype.forEach.call(document.querySelectorAll('.plugin-shortcuts-panel h2'), function (item) {
          var parentPlugin = item.parentNode.cloneNode(true);

          parentPlugin.classList.remove('collapse');
          parentPlugin.style.visibility = 'hidden';
          document.body.appendChild(parentPlugin);
          item.parentNode.style.maxHeight = (parseInt(getComputedStyle(parentPlugin).height) || 0) + 'px';
          parentPlugin.remove();

          item.addEventListener('click', function () {
            this.parentNode.classList.toggle('collapse');
          });
        });
      }, 0);


      // handle shortcut change
      wrapper.addEventListener('keydown', function (ev) {
        if (ev.target.tagName === 'INPUT' && ev.keyCode) {
          var targetKey = source.keyCodes[ev.keyCode];
          var shortcut  = targetKey ? [targetKey] : [];
          var shortcutStr;
          var conflictResult;
          var replacement;

          if (shortcut.length) {
            // handle special keys
            if (ev.metaKey) shortcut.unshift('cmd');
            if (ev.shiftKey) shortcut.unshift('shift');
            if (ev.altKey) shortcut.unshift('option');
            if (ev.ctrlKey) shortcut.unshift('ctrl');

            shortcutStr = shortcut.join(' ');
            conflictResult = shortcutsHandler.checkConflict(shortcutStr);

            if (conflictResult) {
              if (conflictResult.shortcutName !== ev.target.getAttribute('data-command')) {
                // prompt user if this shortcut conflict with Sketch or other plugin
                globalNotice.error(source.i18n.conflict
                                              .replace('${ shortcutName }', conflictResult.shortcutName)
                                              .replace('${ conflictTarget }', conflictResult.name)
                                   , 2000);
              } else {
                ev.target.blur();
              }
            } else {
              replacement = {
                plugin: ev.target.getAttribute('data-plugin'),
                identifier: ev.target.getAttribute('data-identifier'),
                shortcut: shortcut.join(' ')
              };

              // update shortcut and review conflict for input
              reviewConflict(ev.target, convertShortcut(shortcutStr));

              // update shortcut
              shortcutsHandler.setShortcutForPlugin(replacement);

              globalNotice.success(source.i18n.success, 1500);
              ev.target.blur();
            }
          } else if (ev.keyCode === 27) {
            ev.target.blur();
          } else if ([16, 17, 18, 91, 93].indexOf(ev.keyCode) === -1) {
            // except shift, control, option, command keys
            globalNotice.error(source.i18n.notSupport, 1500);
          }

          ev.preventDefault();
        }
      });

      // handle clear action
      wrapper.addEventListener('click', function (ev) {
        if (ev.target.tagName === 'BUTTON') {
          shortcutsHandler.clearShortcutForPlugin({
            plugin: ev.target.getAttribute('data-plugin'),
            identifier: ev.target.getAttribute('data-identifier')
          });

          // clear shortcut and review conflict for input
          reviewConflict(ev.target.previousSibling, '');

          globalNotice.success(source.i18n.clear, 1500);
        }
      });

      document.body.appendChild(wrapper);
    }

    /**
     * set i18n with i18n configurations
     */
    function setI18n(i18n) {
      document.querySelector('.page-title').innerHTML = i18n.title;
      document.querySelector('.usage-desc').innerHTML = i18n.usage;
    }

    /**
     * convert shortcut to symbols
     * @param  {String} str original shortcut
     * @return {String}     shortcut
     */
    function convertShortcut(str) {
      var keys = (str || '').split(' ');
      var mapping = {
        'cmd': '\u2318',
        'command': '\u2318',
        'ctrl': '\u2303',
        'control': '\u2303',
        'alt': '\u2325',
        'option': '\u2325',
        'shift': '\u21E7',
      };

      return keys.map(function (key) {
        return mapping[key] || key;
      }).join('');
    }

    /**
     * review conflict and update shortcut for input
     * @param  {DOM}    targetInput the input which will update
     * @param  {String} newShortcut updating shortcut
     */
    function reviewConflict (targetInput, newShortcut) {
      var inputs;
      var queryStr;
      var plugins = document.querySelectorAll('.plugin-shortcuts-panel.shortcut-conflict');
      var parentRow = targetInput.parentNode.parentNode;

      if (parentRow.classList.contains('shortcut-conflict')) {
        queryStr = '.plugin-shortcuts-panel input[value=' + targetInput.value + ']';
        targetInput.setAttribute('value', newShortcut); // prevent querySelectorAll get error result
        inputs = document.querySelectorAll(queryStr);
        parentRow.classList.remove('shortcut-conflict');

        if (inputs.length === 1) {
          inputs[0].parentNode.parentNode.classList.remove('shortcut-conflict');
        }

        Array.prototype.forEach.call(plugins, function (plugin) {
          if (!plugin.querySelectorAll('.shortcut-conflict').length) {
            plugin.classList.remove('shortcut-conflict');
          }
        });

        renderConflictMsg();
      } else {
        targetInput.value = newShortcut;
      }
    }

    /**
     * render conflict message in header
     */
    function renderConflictMsg() {
      var conflictCommands = document.querySelectorAll('.plugin-shortcuts-panel .shortcut-conflict input');
      var conflictCount = conflictCommands.length;
      var container = document.querySelector('.conflict-warning');
      var conflictDetails = document.querySelector('.conflict-details');

      if (conflictCount) {
        container.innerHTML = i18n.conflictWarning.replace('${ conflictCount }', conflictCount);
        conflictDetails.innerHTML = Array.prototype.map.call(Array.prototype.reduce.call(conflictCommands, function (r, input, index) {
          if (r[input.value]) {
            r[input.value] ++;
          } else {
            r[input.value] = 1;
            r[index] = input.value;
            r.length ? r.length ++ : (r.length = 1);
          }

          return r;
        }, {}), function (item, i, arr) {
          return ['<li onclick="filterPluginList(\'', item ,'\')">', item, '<span>x', arr[item], '</span></li>'].join('');
        }).join('');
      } else {
        container.innerHTML = '';
      }

    }

    /**
     * filter plugin list and command list
     * @param  {String|undefined} shortcut shorcut name; exit filter status
     */
    function filterPluginList(shortcut) {
      // clear current filter targets
      Array.prototype.forEach.call(document.querySelectorAll('.plugin-shortcuts-panel .filter-target'), function (item) {
        item.classList.remove('filter-target');
      });
      if (shortcut) {
        // find filter targets
        Array.prototype.forEach.call(document.querySelectorAll('.plugin-shortcuts-panel input'), function (input) {
          var row = input.parentNode.parentNode;
          if (input.value === shortcut) {
            row.classList.add('filter-target');
            row.parentNode.parentNode.parentNode.classList.add('filter-target'); // plugin
          }
        });
        document.getElementById('panel-wrapper').classList.add('filtered');
      } else {
        document.getElementById('panel-wrapper').classList.remove('filtered');
      }
    }

    /**
     * $initialize by CocoaScript
     * @param  {Object} source source data from CocoaScript
     */
    function $initialize(source) {
      shortcutsHandler = new ShortcutsHandler(source.shortcuts, source.sketchShortcuts);
      i18n = source.i18n;
      setI18n(source.i18n);
      renderList(source);
    }
  </script>
</body>
</html>
