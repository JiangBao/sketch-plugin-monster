<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sketch Plugin Monster</title>
  <style>
    body {
      margin: 0;
      font-family: "Arial", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", "sans-serif";
    }
    .page-title {
      margin: 20px 0 0;
      font-weight: normal;
      font-size: 28px;
      line-height: 40px;
      color: #333;
      text-align: center;
    }
    .usage-desc {
      margin-top: 0;
      margin-bottom: 30px;
      font-size: 14px;
      color: #999;
      text-align: center;
    }
    .plugin-shortcuts-panel {
      margin-top: -1px;
      padding: 0 0 0 20px;
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }
    .plugin-shortcuts-panel h2 {
      margin: 0;
      padding: 0;
      font-weight: normal;
      font-size: 20px;
      line-height: 40px;
      color: #09f;
    }
    .plugin-shortcuts-panel table {
      width: 100%;
      border-collapse: collapse;
    }
    .plugin-shortcuts-panel table td {
      padding: 10px;
      color: #666;
      border-top: 1px solid #eee;
    }
    .plugin-shortcuts-panel table input {
      width: 40px;
      padding: 3px 10px;
      text-align: right;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .plugin-shortcuts-panel table input:focus {
      cursor: initial;
      border-color: #09f;
    }
    .notice-wrapper {
      position: fixed;
      z-index: 100;
      top: 10px;
      left: 0;
      right: 0;
      text-align: center;
    }
    .notice-content {
      display: none;
      max-width: 70%;
      padding: 5px 10px;
      font-size: 14px;
      line-height: 18px;
      text-align: left;
      color: #fff;
      overflow-wrap: break-word;
      background-color: #19C1F3;
      border: 1px solid #17B9E8;
      box-shadow: 0 1px 5px rgba(0,0,0,.2);
      box-sizing: border-box;
    }
    .notice-content.show {
      display: inline-block;
    }
    .notice-content.error {
      background-color: #F91F2E;
      border-color: #E71A27;
    }
    .notice-content.success {
      background-color: #9CDE07;
      border-color: #91CF06;
    }
  </style>
</head>
<body>
  <div class="notice-wrapper">
    <div class="notice-content"></div>
  </div>
  <h1 class="page-title"></h1>
  <p class="usage-desc"></p>
  <script type="text/template" id="shortcuts-template">
    <%for (var i = 0; i < plugins.length; i++) {%>
    <div class="plugin-shortcuts-panel">
      <h2><%=plugins[i].name %></h2>
      <table>
        <tbody>
          <%for (var j = 0; j < plugins[i].commands.length; j++) {%>
          <tr>
            <td><%=plugins[i].commands[j].name %></td>
            <td>
              <input type="text"
                     value="<%=convertShortcut(plugins[i].commands[j].shortcut) %>"
                     data-plugin="<%=plugins[i].name %>"
                     data-identifier="<%=plugins[i].commands[j].identifier %>">
              <button data-plugin="<%=plugins[i].name %>"
                      data-identifier="<%=plugins[i].commands[j].identifier %>">clear</button>
            </td>
          </tr>
          <%}%>
        </tbody>
      </table>
    </div>
    <%}%>
  </script>
  <script>
    // Notification Class
    function Notice() {
      this.content = document.querySelector('.notice-wrapper .notice-content');
    }

    Notice.prototype.show = function (str, duration) {
      var _self = this;
      this.content.classList.add('show');
      this.content.innerHTML = str;
      clearTimeout(this.timer);
      duration && (this.timer = setTimeout(function () {
        _self.hide();
      }, duration));
    };

    Notice.prototype.error = function (str, duration) {
      this.content.classList.add('error');
      this.show(str, duration);
    };

    Notice.prototype.success = function (str, duration) {
      this.content.classList.add('success');
      this.show(str, duration);
    };

    Notice.prototype.hide = function () {
      this.content.innerHTML = '';
      this.content.className = 'notice-content';
      clearTimeout(this.timer);
    };
  </script>
  <script>
    // Shortcuts handler Class
    function ShortcutsHandler(shortcuts, sketchShortcuts) {
      var keyPriorities = {
        ctrl: 5,
        control: 5,
        shift: 4,
        option: 3,
        alt: 3,
        cmd: 2,
        command: 2
      };

      // sort shortcut keys, eg: "(ctrl) (shift) (option) (cmd) key"
      shortcuts.forEach(function (plugin) {
        plugin.commands.forEach(function (command) {
          var handleShortcut = (command.shortcut || '').trim();

          if (handleShortcut &&
              !/^(ctrl |control )?(shift )?(option |alt )?(cmd |command )?.{1}$/
                .test(handleShortcut)) {
            command.shortcut = handleShortcut.split(' ').sort(function (prev, next) {
              var prevPriority = keyPriorities[prev] || 1;
              var nextPriority = keyPriorities[next] || 1;

              return nextPriority - prevPriority;
            }).join(' ');
          }
        });
      });

      this.raw = shortcuts;
      this.sketchRaw = sketchShortcuts;
    }

    ShortcutsHandler.prototype.getCommandsList = function () {
      return this.raw;
    };

    ShortcutsHandler.prototype.checkConflict = function (shortcut) {
      var result;
      var i;
      var j;

      if (this.sketchRaw[shortcut]) {
        result = {
          name: 'Sketch',
          shortcutName: this.sketchRaw[shortcut]
        };
      } else {
        for (i = 0; i < this.raw.length; i++) {
          for (j = 0; j < this.raw[i].commands.length; j++) {
            if (this.raw[i].commands[j].shortcut === shortcut) {
              result = {
                name: this.raw[i].name,
                shortcutName: this.raw[i].commands[j].name
              };

              i = this.raw.length;
              break;
            }
          }
        }
      }

      return result;
    };

    ShortcutsHandler.prototype.setShortcutForPlugin = function (replacement) {
      var i;
      var j;

      for (i = 0; i < this.raw.length; i++) {
        if (this.raw[i].name === replacement.plugin) {
          for(j = 0; j < this.raw[i].commands.length; j++) {
            if (this.raw[i].commands[j].identifier === replacement.identifier) {
              if (replacement.shortcut) {
                this.raw[i].commands[j].shortcut = replacement.shortcut;
                // save shortcut for plugin
                $dispatch('$pluginShortcut:set', replacement);
              } else {
                delete this.raw[i].commands[j].shortcut;
                // clear shortcut for plugin
                $dispatch('$pluginShortcut:clear', replacement);
              }
              i = this.raw.length;
              break;
            }
          }
        }
      }
    };

    ShortcutsHandler.prototype.clearShortcutForPlugin = function (replacement) {
      delete replacement.shortcut;
      this.setShortcutForPlugin(replacement);
    };
  </script>
  <script>
    // Simple template engine Class
    function TemplateEngine(templateId) {
      var template = document.getElementById(templateId).innerHTML;
      var templateParsed = ['var $out = [];\nwith ($data) {'];

      template.split('\n').forEach(function (line) {
        var parsed;

        line = line.trim();

        if (/<%=/.test(line)) {
          // parse data output
          templateParsed.push('$out.push(\'' + line.replace(/<%= ?([a-z\(\)\.\[\]_]*) ?%>/gi, '\' + $1 + \'') + '\');');
        } else if (/<% ?for ?\(/.test(line)) {
          // parse for iteration
          templateParsed.push(line.replace(/<% ?(for ?\(.*\) ?{) ?%>/gi, '$1'));
        } else if (/^<% ?} ?%>$/.test(line)) {
          templateParsed.push('}');
        } else if (!/^[\s\n]*$/.test(line)) {
          templateParsed.push('$out.push(\'' + line + '\');');
        }
      });

      templateParsed.push('}\nreturn $out.join(\'\')');

      return function (data) {
        return new Function('$data', templateParsed.join(''))(data);
      };
    }
  </script>
  <script>
    var globalNotice = new Notice();
    var shortcutsHandler;

    function renderList(source) {
      var listRender = new TemplateEngine('shortcuts-template');
      var wrapper = document.createElement('div');

      wrapper.innerHTML = listRender({ plugins: source.shortcuts });

      // handle shortcut change
      wrapper.addEventListener('keydown', function (ev) {
        if (ev.target.tagName === 'INPUT' && ev.keyCode) {
          var targetKey = source.keyCodes[ev.keyCode];
          var shortcut  = targetKey ? [targetKey] : [];
          var shortcutStr;
          var conflictResult;
          var replacement;

          if (shortcut.length) {
            // handle special keys
            if (ev.metaKey) shortcut.unshift('cmd');
            if (ev.shiftKey) shortcut.unshift('shift');
            if (ev.altKey) shortcut.unshift('option');
            if (ev.ctrlKey) shortcut.unshift('ctrl');

            shortcutStr = shortcut.join(' ');
            conflictResult = shortcutsHandler.checkConflict(shortcutStr);

            if (conflictResult) {
              if (conflictResult.name !== ev.target.getAttribute('data-plugin')) {
                // prompt user if this shortcut conflict with Sketch or other plugin
                globalNotice.error(source.i18n.conflict
                                              .replace('${ shortcutName }', conflictResult.shortcutName)
                                              .replace('${ conflictTarget }', conflictResult.name)
                                   , 2000);
              } else {
                ev.target.blur();
              }
            } else {
              replacement = {
                plugin: ev.target.getAttribute('data-plugin'),
                identifier: ev.target.getAttribute('data-identifier'),
                shortcut: shortcut.join(' ')
              };

              // update shortcut to input
              ev.target.value = convertShortcut(shortcutStr);

              // update shortcut
              shortcutsHandler.setShortcutForPlugin(replacement);

              globalNotice.success(source.i18n.success, 1500);
              ev.target.blur();
            }
          } else if (ev.keyCode === 27) {
            ev.target.blur();
          } else if ([16, 17, 18, 91, 93].indexOf(ev.keyCode) === -1) {
            // except shift, control, option, command keys
            globalNotice.error(source.i18n.notSupport, 1500);
          }

          ev.preventDefault();
        }
      });

      // handle clear action
      wrapper.addEventListener('click', function (ev) {
        if (ev.target.tagName === 'BUTTON') {
          shortcutsHandler.clearShortcutForPlugin({
            plugin: ev.target.getAttribute('data-plugin'),
            identifier: ev.target.getAttribute('data-identifier')
          });
          ev.target.previousSibling.value = '';
        }
      });

      document.body.appendChild(wrapper);
    }

    function setI18n(i18n) {
      document.querySelector('.page-title').innerHTML = i18n.title;
      document.querySelector('.usage-desc').innerHTML = i18n.usage;
    }

    function convertShortcut(str) {
      var keys = (str || '').split(' ');
      var mapping = {
        'cmd': '\u2318',
        'command': '\u2318',
        'ctrl': '\u2303',
        'control': '\u2303',
        'alt': '\u2325',
        'option': '\u2325',
        'shift': '\u21E7',
      };

      return keys.map(function (key) {
        return mapping[key] || key;
      }).join('');
    }

    function $initialize(source) {
      shortcutsHandler = new ShortcutsHandler(source.shortcuts, source.sketchShortcuts);
      setI18n(source.i18n);
      renderList(source);
    }
  </script>
</body>
</html>
